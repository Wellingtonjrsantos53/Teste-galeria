<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, getDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURAÇÃO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDUQq0J96QQpGSbEXrnLjnsSCSGTzQlVns",
        authDomain: "galeria-do-site-duplicado.firebaseapp.com",
        projectId: "galeria-do-site-duplicado",
        storageBucket: "galeria-do-site-duplicado.firebasestorage.app",
        messagingSenderId: "717918810787",
        appId: "1:717918810787:web:01c7cbc1a1b7b880bb8516",
        measurementId: "G-ZFNYWV4BFB"
    };
    
    // --- VARIÁVEIS GERAIS ---
    const API_BASE_URL = 'https://pagamento-de-projetosvercelapp-wellingtons-projects-02014e31.vercel.app'; 
    const PAYMENT_ENDPOINT = '/create_payment'; 

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // --- Funções de Ajuda ---
    
    const getProjectIdFromUrl = () => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        return id ? id.trim() : null;
    };

    const formatComodosList = (listaComodos) => {
        if (!listaComodos || listaComodos.length === 0) {
            return 'N/A';
        }
        return listaComodos.map(item => `${item.comodo} (${item.quantidade})`).join(', ');
    };

    // --- FUNÇÃO DE PAGAMENTO (Gera o QR Code na MESMA página) ---
    window.createPixPayment = async (projeto) => {
        const form = document.getElementById('payerForm');
        const pixOutputContainer = document.getElementById('pix-output-container'); // Onde renderizamos o PIX
        const btn = document.getElementById('generatePixButton');

        // 1. VALIDAÇÃO DO FORMULÁRIO
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // 2. COLETA DOS DADOS REAIS DO PAGADOR
        const payerData = {
            email: document.getElementById('payerEmail').value,
            first_name: document.getElementById('payerFirstName').value,
            last_name: document.getElementById('payerLastName').value,
            identification: {
                type: 'CPF',
                number: document.getElementById('payerDocument').value.replace(/\D/g, '')
            }
        };

        btn.disabled = true;
        pixOutputContainer.innerHTML = '<p class="text-indigo-500">Gerando QR Code e Chave PIX. Aguarde...</p>';
        pixOutputContainer.classList.remove('hidden'); // Mostra a área de feedback

        // 3. CORPO DA REQUISIÇÃO
        const paymentBody = {
            transaction_amount: projeto.valorProjeto,
            description: `Projeto: ${projeto.tipoProjeto || 'Sem Nome'}`,
            payment_method_id: 'pix', 
            payer: payerData,
        };

        try {
            const response = await fetch(`${API_BASE_URL}${PAYMENT_ENDPOINT}`, { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(paymentBody),
            });

            const responseText = await response.text();

            if (!response.ok) {
                console.error("Erro HTTP:", response.status, responseText);
                pixOutputContainer.innerHTML = `<p class="text-red-500">Erro na API. Status: ${response.status}. Verifique os logs do Vercel.</p>`;
                btn.disabled = false;
                return;
            }
            
            // Converte para JSON
            const data = JSON.parse(responseText); 

            if (data.qr_code_base64) {
                // SUCESSO: Exibe o QR Code e a chave
                const valorFormatado = projeto.valorProjeto.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                document.getElementById('payerForm').style.display = 'none'; // ESCONDE O FORMULÁRIO
                
                // --- RENDERIZAÇÃO DO QR CODE NA MESMA PÁGINA ---
                document.getElementById('payment-section').classList.add('p-8'); // Adiciona padding extra
                document.getElementById('payment-section').innerHTML = `
                    <h3 class="text-2xl font-bold text-green-600 mb-2">Seu PIX Foi Gerado!</h3>
                    <p class="text-gray-600 mb-6">Leia o QR Code abaixo para pagar **${valorFormatado}** e finalizar sua compra.</p>
                    
                    <img src="data:image/jpeg;base64,${data.qr_code_base64}" 
                        alt="QR Code PIX" 
                        class="mx-auto border-4 border-indigo-500 p-2 rounded-lg mb-6 w-52 h-52 shadow-xl"/>
                    
                    <div class="bg-gray-100 p-4 rounded-lg mb-4">
                        <strong class="block text-sm text-gray-700 mb-1">Chave Copia e Cola:</strong>
                        <span id="pixCode" class="font-mono text-xs text-gray-800 break-all">${data.qr_code_text}</span>
                    </div>
                    
                    <button onclick="navigator.clipboard.writeText(document.getElementById('pixCode').textContent)" class="w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg transition-colors">
                        Copiar Chave PIX
                    </button>

                    <p class="text-xs text-red-500 mt-4">
                        A transação será confirmada em breve. Você pode fechar esta janela após o pagamento.
                    </p>
                    <p class="text-xs text-gray-400 mt-2">
                        Referência de Pagamento: ${data.payment_id}
                    </p>
                `;

            } else {
                // ERRO DA API - Retorno do Mercado Pago
                console.error("Erro retornado pelo Mercado Pago:", data.error);
                pixOutputContainer.innerHTML = `<p class="text-red-500">Falha na geração do PIX. Erro MP: ${data.error || 'Desconhecido'}</p>`;
                btn.disabled = false;
            }

        } catch (e) {
            console.error("Erro fatal na comunicação:", e);
            pixOutputContainer.innerHTML = `<p class="text-red-500">Falha ao conectar com o servidor. Tente novamente mais tarde.</p>`;
            btn.disabled = false;
        }
    };

    // --- RENDERIZAÇÃO DA PÁGINA (Mantém o formulário) ---
    const renderPurchasePage = async (docId) => {
        const container = document.getElementById('purchase-container');
        
        if (!docId) {
            container.innerHTML = `<p class="text-red-500 text-lg">Projeto não encontrado. ID ausente na URL.</p>`;
            return;
        }

        try {
            // 1. Busca o documento no Firestore
            const projectRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/galleries`, docId);
            const projectSnap = await getDoc(projectRef);

            if (!projectSnap.exists()) {
                container.innerHTML = `<p class="text-red-500 text-lg">Projeto com ID ${docId} não encontrado.</p>`;
                return;
            }

            const projeto = projectSnap.data();
            const title = projeto.tipoProjeto || 'Projeto Sem Nome';
            const valor = projeto.valorProjeto || 0;
            const valorFormatado = valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const comodosDetalhe = formatComodosList(projeto.listaComodos);

            // Renderiza o formulário e o botão
            container.innerHTML = `
                <h2 class="text-3xl font-extrabold text-indigo-700 mb-6">${title}</h2>
                
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">Resumo do Pedido</h3>
                    <div class="space-y-2 text-gray-600">
                        <p><strong>Tipo:</strong> ${title}</p>
                        <p><strong>Cômodos:</strong> ${comodosDetalhe}</p>
                        <p class="text-2xl font-bold text-green-600 border-t pt-2 mt-2">Valor Total: ${valorFormatado}</p>
                    </div>
                </div>

                <div id="payment-section" class="bg-white p-6 rounded-lg shadow-xl border-2 border-indigo-200">
                    <h3 class="text-2xl font-bold text-indigo-700 mb-4 text-center">Dados do Comprador (Requerido)</h3>
                    
                    <form id="payerForm" onsubmit="event.preventDefault(); window.createPixPayment(${JSON.stringify(projeto)})">
                        
                        <div class="space-y-4">
                            <div>
                                <label for="payerFirstName" class="block text-sm font-medium text-gray-700">Nome</label>
                                <input type="text" id="payerFirstName" name="payerFirstName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="payerLastName" class="block text-sm font-medium text-gray-700">Sobrenome</label>
                                <input type="text" id="payerLastName" name="payerLastName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="payerEmail" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="payerEmail" name="payerEmail" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="payerDocument" class="block text-sm font-medium text-gray-700">CPF/CNPJ (Apenas números)</label>
                                <input type="text" id="payerDocument" name="payerDocument" required minlength="11" maxlength="14" pattern="[0-9]+" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                        </div>
                        
                        <button 
                            type="submit"
                            id="generatePixButton" 
                            class="mt-6 w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-colors shadow-lg disabled:opacity-50"
                        >
                            Gerar QR Code PIX e Finalizar Compra
                        </button>
                    </form>
                    
                    <div id="pix-output-container" class="mt-4 hidden text-center"></div> 
                </div>
            `;

            } catch (error) {
                console.error("Erro ao carregar o projeto:", error);
                container.innerHTML = `<p class="text-red-500 text-lg">Erro ao carregar os dados. Verifique a conexão com o Firebase.</p>`;
            }
        };

        // Função que inicia o processo
        const loadPurchaseData = () => {
             onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    await signInAnonymously(auth);
                }
                const projectId = getProjectIdFromUrl();
                renderPurchasePage(projectId);
            });
        }

        loadPurchaseData();
    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800 p-4 md:p-8">
    <div class="container mx-auto max-w-2xl">
        <header class="text-center mb-8">
            <a href="index.html" class="text-indigo-500 hover:text-indigo-700 transition-colors block mb-4">&larr; Voltar para a Galeria</a>
            <h1 class="text-4xl font-extrabold text-gray-800">Finalizar Compra</h1>
        </header>

        <div id="purchase-container" class="space-y-6">
            <p class="text-center text-gray-500">Carregando detalhes do projeto...</p>
        </div>
    </div>
</body>
</html>